image: atlassianlabs/docker-node-jdk-chrome-firefox:latest
options:
  max-time: 10 # minutes
clone:
  depth: full
definitions:
  caches:
    sonar: ~/.sonar/cache
    prototype-node: prototype/node_modules
  steps:
    - step: &validate
        name: Validate
        caches:
          - node
          - prototype-node
        script:
          - npm install --unsafe-perm
          - npm run lint:ci
          - npm run test:ci
          - npm run sonar:ci-js
          - npm run sonar:ci-scss
        artifacts:
          - prototype/reports/**
    - step: &build
        name: Build
        caches:
          - node
          - prototype-node
        script:
          - npm install --unsafe-perm
          - npm run build:ci
        artifacts:
          - prototype/deploy/**
    - step: &build-gated
        name: Quality Gate, then Build
        caches:
          - node
          - prototype-node
          - sonar
        script:
          - pipe: sonarsource/sonarcloud-scan:0.1.5
            variables:
              SONAR_TOKEN: ${SONAR_TOKEN}
              EXTRA_ARGS: '-Dsonar.projectBaseDir=./prototype'
          - npm install --unsafe-perm
          - npm run build:ci
        artifacts:
          - prototype/deploy/**
    - step: &deploy
        name: Deploy
        deployment: test
        script:
          - ls prototype/{,deploy}
pipelines:
  default:
    - step: *validate
  pull-requests:
    '**':
      - step: *validate
      - step: *build-gated
      - step: *deploy
  branches:
    master:
      - step: *validate
      - step: *build-gated
      - step:
          <<: *deploy
          deployment: staging
          trigger: manual
    'release/*':
      - step: *build
      - step:
          <<: *deploy
          deployment: production
          trigger: manual
